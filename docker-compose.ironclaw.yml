version: '3.8'

services:
  # --- THE BRAIN (Python GCA) ---
  gca-service:
    build:
      context: ./gca-service
    image: openclaw-gca-brain
    container_name: gca-brain
    restart: unless-stopped
    ports:
      - "8000:8000"
    volumes:
      - ./gca-service/gca_assets:/app/gca_assets
      - claw_state:/app/openclaw_state
      - ./.agent:/.agent
    environment:
      - PYTHONUNBUFFERED=1
      # Local Qwen model doesn't strictly need API key but keeping structure
      - GCA_LOG_LEVEL=INFO
      - OPENCLAW_GATEWAY_TOKEN=${OPENCLAW_GATEWAY_TOKEN}
      - OPENCLAW_STATE_DIR=/app/openclaw_state
    networks:
      - claw-net
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]

  # --- THE BODY (OpenClaw / Gateway) ---
  gateway:
    build: .  # Uses the root Dockerfile
    image: openclaw-gateway
    container_name: openclaw-gateway
    restart: unless-stopped
    depends_on:
      - gca-service
    environment:
      - NODE_ENV=production
      # This points the OpenClaw extension to the Docker container name
      - GCA_API_URL=http://gca-brain:8000
      - ENABLED_EXTENSIONS=gca-brain,voice-call
      # OpenClaw required vars (from original ironclaw compose)
      - OPENCLAW_GATEWAY_TOKEN=${OPENCLAW_GATEWAY_TOKEN}
    ports:
      - "3000:3000"
    volumes:
      - ./.agent:/app/.agent
      - ./extensions:/app/extensions
      - claw_state:/home/node/.openclaw
    networks:
      - claw-net

networks:
  claw-net:
    driver: bridge

volumes:
  claw_state:
