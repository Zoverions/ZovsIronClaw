version: '3.8'

# ZovsIronClaw Docker Compose Configuration
# Integrates OpenClaw with GCA (Geometric Conscience Architecture) service

services:
  # OpenClaw Gateway with GCA Integration
  openclaw-gateway:
    image: ${OPENCLAW_IMAGE:-openclaw:local}
    container_name: ironclaw-gateway
    environment:
      HOME: /home/node
      TERM: xterm-256color
      
      # OpenClaw configuration
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN}
      CLAUDE_AI_SESSION_KEY: ${CLAUDE_AI_SESSION_KEY}
      CLAUDE_WEB_SESSION_KEY: ${CLAUDE_WEB_SESSION_KEY}
      CLAUDE_WEB_COOKIE: ${CLAUDE_WEB_COOKIE}
      
      # GCA Integration
      GCA_SERVICE_URL: http://gca-service:8000
      GCA_RISK_TOLERANCE: ${GCA_RISK_TOLERANCE:-0.3}
      GCA_USE_QPT: ${GCA_USE_QPT:-true}
      GCA_DEFAULT_SOUL: ${GCA_DEFAULT_SOUL:-architect}
      
      # API Keys
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      XAI_API_KEY: ${XAI_API_KEY}
    volumes:
      - ${OPENCLAW_CONFIG_DIR}:/home/node/.openclaw
      - ${OPENCLAW_WORKSPACE_DIR}:/home/node/.openclaw/workspace
    ports:
      - "${OPENCLAW_GATEWAY_PORT:-18789}:18789"
      - "${OPENCLAW_BRIDGE_PORT:-18790}:18790"
    init: true
    restart: unless-stopped
    depends_on:
      gca-service:
        condition: service_healthy
    networks:
      - ironclaw-network
    command:
      [
        "node",
        "dist/index.js",
        "gateway",
        "--bind",
        "${OPENCLAW_GATEWAY_BIND:-lan}",
        "--port",
        "18789",
      ]

  # OpenClaw CLI with GCA Integration
  openclaw-cli:
    image: ${OPENCLAW_IMAGE:-openclaw:local}
    container_name: ironclaw-cli
    environment:
      HOME: /home/node
      TERM: xterm-256color
      BROWSER: echo
      
      # OpenClaw configuration
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN}
      CLAUDE_AI_SESSION_KEY: ${CLAUDE_AI_SESSION_KEY}
      CLAUDE_WEB_SESSION_KEY: ${CLAUDE_WEB_SESSION_KEY}
      CLAUDE_WEB_COOKIE: ${CLAUDE_WEB_COOKIE}
      
      # GCA Integration
      GCA_SERVICE_URL: http://gca-service:8000
      GCA_RISK_TOLERANCE: ${GCA_RISK_TOLERANCE:-0.3}
      GCA_USE_QPT: ${GCA_USE_QPT:-true}
      GCA_DEFAULT_SOUL: ${GCA_DEFAULT_SOUL:-companion}
      
      # API Keys
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      XAI_API_KEY: ${XAI_API_KEY}
    volumes:
      - ${OPENCLAW_CONFIG_DIR}:/home/node/.openclaw
      - ${OPENCLAW_WORKSPACE_DIR}:/home/node/.openclaw/workspace
    stdin_open: true
    tty: true
    init: true
    depends_on:
      gca-service:
        condition: service_healthy
    networks:
      - ironclaw-network
    entrypoint: ["node", "dist/index.js"]

  # GCA Service (Geometric Conscience Architecture)
  gca-service:
    build:
      context: ./gca-service
      dockerfile: Dockerfile
    container_name: ironclaw-gca
    environment:
      # API Keys
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      
      # GCA Configuration
      GCA_RISK_TOLERANCE: ${GCA_RISK_TOLERANCE:-0.3}
      GCA_LOG_LEVEL: ${GCA_LOG_LEVEL:-INFO}
      
      # Python configuration
      PYTHONUNBUFFERED: 1
    ports:
      - "${GCA_SERVICE_PORT:-8000}:8000"
    volumes:
      # Persistent storage for vectors, souls, and logs
      - ./gca-service/gca_assets:/app/gca_assets
      - gca-logs:/app/logs
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - ironclaw-network

  # Optional: Arena Protocol Runner (for testing)
  # Uncomment to run continuous adversarial testing
  # arena-runner:
  #   build:
  #     context: ./gca-service
  #     dockerfile: Dockerfile
  #   container_name: ironclaw-arena
  #   environment:
  #     GEMINI_API_KEY: ${GEMINI_API_KEY}
  #     GCA_SERVICE_URL: http://gca-service:8000
  #   command: ["python", "-c", "import time; import requests; time.sleep(60); requests.get('http://gca-service:8000/v1/arena/run?rounds=10')"]
  #   depends_on:
  #     - gca-service
  #   networks:
  #     - ironclaw-network
  #   restart: on-failure

networks:
  ironclaw-network:
    driver: bridge
    name: ironclaw-network

volumes:
  gca-logs:
    name: ironclaw-gca-logs
